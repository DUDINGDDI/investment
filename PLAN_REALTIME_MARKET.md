# 실시간 투자 시뮬레이터 확장 계획

> 현재 단순 코인 투자/철회 구조 → 참가자 행동 기반 실시간 가격 변동 시스템으로 전환
> 2시간 행사, 400명 동시접속, 30개 부스 기준

## 현재 상태 (AS-IS)

- 투자: 금액(amount) 기반. 10만 코인 투자 → 10만 코인 그대로 보관
- 철회: 투자한 금액 그대로 회수
- 가격 개념 없음. 수익/손실 없음
- 랭킹: 총 투자금액 순
- SSE 인프라: 공지 브로드캐스트용 `SseEmitterService` 존재

## 목표 상태 (TO-BE)

참가자가 많이 사면 가격 오르고, 많이 팔면 내리는 **수요/공급 기반 시장**. 별도 랜덤 엔진 없이 참가자 행동만으로 가격 결정 → 눈치싸움·심리전 유도.

---

## 1. 유닛 기반 매매 시스템

### 데이터 구조 변경

**Booth 엔티티 확장:**
```
currentPrice: Long        -- 현재 1유닛 가격 (초기값: 10,000)
previousPrice: Long       -- 직전 가격 (변동률 표시용)
totalSupply: Long          -- 총 발행 유닛 수 (매수 시 증가, 매도 시 감소)
basePrice: Long            -- 기준가 (이벤트 리셋 등에 사용)
```

**Investment 엔티티 변경:**
```
-- 기존: amount (투자 금액)
-- 변경:
units: Long                -- 보유 유닛 수
totalCost: Long            -- 총 매수 원금 (평균단가 계산용)
```

**PriceHistory 엔티티 (신규):**
```
id: Long
boothId: Long
price: Long
timestamp: Instant
```
→ 차트 데이터용. 가격 변경 시마다 기록.

**InvestmentHistory 확장:**
```
-- 기존: type, amount
-- 추가:
priceAtTime: Long          -- 거래 시점 가격
units: Long                -- 거래 유닛 수
```

### 매매 로직

**매수:**
```
투자금 100,000 코인, 현재 가격 1,000원/유닛
→ 100유닛 매수
→ User 잔액 -= 100,000
→ Investment.units += 100, Investment.totalCost += 100,000
→ Booth.totalSupply += 100
→ 가격 재계산
```

**매도:**
```
50유닛 매도, 현재 가격 1,500원/유닛
→ 매도 금액 = 50 × 1,500 = 75,000 코인
→ User 잔액 += 75,000
→ Investment.units -= 50, Investment.totalCost -= (50 × 평균단가)
→ Booth.totalSupply -= 50
→ 가격 재계산
```

### 가격 계산 공식 (수요/공급 기반)

```
newPrice = basePrice × (1 + totalSupply × sensitivity)
```

- `sensitivity`: 민감도 계수 (0.001 ~ 0.01 사이, 튜닝 필요)
- 매수 → totalSupply 증가 → 가격 상승
- 매도 → totalSupply 감소 → 가격 하락
- 최소 가격 제한: basePrice × 0.1 (90% 이상 하락 방지)
- 최대 가격 제한: basePrice × 10.0 (10배 상한)

> 민감도는 행사 전 테스트로 조정. 400명 기준 너무 민감하면 급등락 과다, 너무 둔감하면 재미 없음.

---

## 2. 실시간 가격 브로드캐스트

### SSE 채널 확장

현재 `SseEmitterService`를 확장하거나 별도 서비스 생성:

```
GET /api/results/prices → SSE 구독 (가격 전용)
```

**이벤트 종류:**
- `price-update`: 전체 부스 가격 일괄 전송 (매매 발생 시 or 5초 주기)
- `event`: 관리자 이벤트 발생 알림

**전송 데이터 형식:**
```json
{
  "prices": [
    { "boothId": 1, "currentPrice": 12500, "previousPrice": 11000, "changeRate": 13.6, "investorCount": 85 },
    ...
  ],
  "timestamp": "2026-02-22T10:30:00Z"
}
```

### 브로드캐스트 전략

- 매매 발생할 때마다 즉시 전송하면 400명 × 빈번한 거래 = 과부하
- **해결:** 가격 변경을 버퍼링하고 5~10초 간격으로 일괄 브로드캐스트
- `@Scheduled(fixedRate = 5000)` 으로 주기적 전송
- 급등/급락(±10% 이상) 시에는 즉시 전송

---

## 3. 관리자 이벤트 시스템

### 이벤트 종류

| 이벤트 | 효과 | 예시 |
|--------|------|------|
| 호재 | 특정 부스 가격 +N% | "5번 부스 대박 뉴스!" |
| 악재 | 특정 부스 가격 -N% | "12번 부스 스캔들 발생!" |
| 시장 충격 | 전 부스 가격 -N% | "글로벌 위기!" |
| 시장 호황 | 전 부스 가격 +N% | "경기 부양책 발표!" |
| 매매 정지 | 특정 부스 N분간 거래 불가 | "3번 부스 거래 정지 3분" |
| 정보 공개 | 힌트 텍스트 전송 (가격 변동 없음) | "가장 저평가된 부스는..." |

### 데이터 구조

**MarketEvent 엔티티 (신규):**
```
id: Long
type: String               -- BOOST, CRASH, MARKET_SHOCK, MARKET_BOOM, HALT, INFO
targetBoothId: Long         -- null이면 전체 대상
percentage: Integer         -- 가격 변동률 (INFO일 때는 null)
message: String             -- 참가자에게 표시할 메시지
createdAt: Instant
```

### Admin API 확장

```
POST /api/admin/events      -- 이벤트 발동
GET  /api/admin/events       -- 이벤트 히스토리
```

이벤트 발동 시:
1. 대상 부스 가격에 percentage 즉시 반영
2. PriceHistory 기록
3. SSE로 전체 참가자에게 이벤트 알림 + 변경된 가격 브로드캐스트

---

## 4. 라운드/타이머 관리

### 2시간 타임라인

```
0:00~0:05   오프닝 (매매 불가, 규칙 설명)
0:05~0:50   1라운드 (45분, 자유 매매)
0:50~1:00   중간 정산 (매매 불가, 중간 랭킹 공개 + 이벤트 발동)
1:00~1:45   2라운드 (45분, 자유 매매)
1:45~2:00   최종 정산 (매매 마감, 최종 랭킹 + 시상)
```

### AppSetting 확장

```
game_phase: "WAITING" | "ROUND_1" | "INTERMISSION" | "ROUND_2" | "FINISHED"
round_end_time: "2026-02-22T11:50:00Z"    -- 현재 구간 종료 시각
```

- 매매 API에서 phase 체크 → ROUND_1, ROUND_2 일 때만 매매 허용
- 프론트에서 남은 시간 카운트다운 표시
- 관리자 페이지에서 라운드 전환 버튼

---

## 5. 수익률/랭킹 변경

### 자산 계산

```
총 자산 = 잔액 + Σ(각 부스 보유유닛 × 현재가격)
수익률 = (총 자산 - 초기자금) / 초기자금 × 100
```

### 랭킹 기준 옵션

- **수익률 순** (추천): 소액 투자자도 역전 가능 → 참여 동기 유지
- **총 자산 순**: 단순 명확

### 프론트 표시

```
내 자산: 1,230,000 코인 (+23.0%)
랭킹: 42위 / 400명
```

---

## 6. 프론트엔드 변경 사항

### 부스 목록 (BoothListPage)
- 현재 가격 + 등락률 표시 (▲+13.6% / ▼-5.2%)
- 실시간 가격 SSE 연동
- 투자자 수 표시

### 부스 상세 (BoothDetailPage)
- 가격 차트 (PriceHistory 기반 라인 차트)
- 매수: 금액 입력 → "N유닛 매수 예정" 표시
- 매도: 유닛 수 기반 매도 → "예상 수령 N코인" 표시
- 내 평균단가, 수익률 표시

### 홈 (HomePage)
- 총 자산 + 수익률
- 보유 부스별 평가금액 도넛 차트
- 실시간 가격 변동 티커 (상단 흐르는 텍스트)
- 남은 시간 카운트다운

### 이벤트 알림
- 관리자 이벤트 발생 시 전체 화면 오버레이 or 토스트로 표시
- "🚨 5번 부스 호재 발생! +20%"
- 기존 AnnouncementBanner SSE 패턴 확장

### 관리자 (AdminPage)
- 이벤트 발동 UI (부스 선택 + 종류 + 비율)
- 라운드 전환 버튼
- 전체 부스 가격 현황 대시보드
- 실시간 거래량 모니터링

---

## 7. 구현 우선순위

### Phase 1: 핵심 매매 시스템
1. Booth 엔티티에 가격 필드 추가
2. Investment를 유닛 기반으로 변경
3. PriceHistory 엔티티 추가
4. InvestmentService 매매 로직 변경 (가격 계산 포함)
5. data.sql에 30개 부스 시드 + 초기 가격

### Phase 2: 실시간 가격 전파
6. 가격 SSE 브로드캐스트 서비스
7. 프론트 부스 목록/상세 실시간 가격 연동
8. 홈 화면 총 자산/수익률 표시

### Phase 3: 이벤트 시스템
9. MarketEvent 엔티티 + API
10. 관리자 이벤트 발동 UI
11. 프론트 이벤트 알림 표시

### Phase 4: 라운드/게임 관리
12. 라운드 상태 관리 (AppSetting)
13. 매매 가능/불가 phase 체크
14. 카운트다운 타이머
15. 중간/최종 랭킹 화면

---

## 8. 성능 고려사항

- 가격 브로드캐스트: 400개 SSE 연결 × 5초 간격 → 충분히 감당 가능
- 동시 매매: 기존 비관적 락 유지, 가격 계산은 Booth 단위 락
- PriceHistory: 30부스 × 5초 간격 × 2시간 = ~43,200건. H2/MySQL 모두 문제 없음
- 프론트 렌더링: 가격 업데이트 시 변경된 부스만 리렌더 (React key 기반)
